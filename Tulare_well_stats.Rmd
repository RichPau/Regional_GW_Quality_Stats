---
title: "Regional Groundwater Quality Trends in the Tulare Basin"
author: "Rich Pauloo"
date: "August 22, 2017"
output: 
  html_document:
    toc: TRUE
    toc_float: TRUE
    smooth_scroll: FALSE
bibliography: Tulare_TDS_ref.bib
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

##### This analysis explores inorganic (TDS) groundwater contamination in the Tulare Basin, California. Data was generously provided by [CV-SALTS](https://www.cvsalinity.org/) and [CDM Smith](https://cdmsmith.com/), and aggregated from:

* United States Geologic Survey[^1]
* California Department of Public Health[^2] 
* Groundwater Ambient Monitoring and Assessment Program[^3]  
* Environmental Defense Fund[^4]
* California Department of Water Resources[^5]
* independent dairy farm monitoring wells

##### All data cleaning, analysis, and mapping was carried out within R version 1.0.143.  

##### All scripts, versions, data input files, and documentation for this model can be found in [this Github repository.](https://github.com/RichPau/Contaminant-Mapping)

# Summary of Results
* Groundwater quality data in the Tulare Basin is well-distributed spatially, with more data spatially concentrated near the urban centers of Fresno and Bakersfield. 
* Temporally, groundwater quality data ranges from 1902 - 2014. Later years (1980 - 2014) are much more data rich than early years (1902 - 1940). 
* Discontinuous data is more common than continuous data.
* Both continuous and discountinuous data from shallow and deep wells show increases in measured TDS, which suggests depreciation of regional groundwater quality in the Tulare Basin.

# Define Useful Functions
```{r}
# multiplot function from Winston Chang's "R Cookbook"
multiplot <- function(..., plotlist=NULL, file, cols=1, layout=NULL) {
  library(grid)

  # Make a list from the ... arguments and plotlist
  plots <- c(list(...), plotlist)

  numPlots = length(plots)

  # If layout is NULL, then use 'cols' to determine layout
  if (is.null(layout)) {
    # Make the panel
    # ncol: Number of columns of plots
    # nrow: Number of rows needed, calculated from # of cols
    layout <- matrix(seq(1, cols * ceiling(numPlots/cols)),
                    ncol = cols, nrow = ceiling(numPlots/cols))
  }

 if (numPlots==1) {
    print(plots[[1]])

  } else {
    # Set up the page
    grid.newpage()
    pushViewport(viewport(layout = grid.layout(nrow(layout), ncol(layout))))

    # Make each plot, in the correct location
    for (i in 1:numPlots) {
      # Get the i,j matrix positions of the regions that contain this subplot
      matchidx <- as.data.frame(which(layout == i, arr.ind = TRUE))

      print(plots[[i]], vp = viewport(layout.pos.row = matchidx$row,
                                      layout.pos.col = matchidx$col))
    }
  }
}

```

# Load Data and Required Packages
```{r set wd, load required packages, and load data, warning = FALSE, messages = FALSE, results="hide", errors = FALSE}
#setwd("E:/rpauloo/Documents/GitHub/Contaminant-Mapping")
setwd("/Users/richpauloo/Documents/GitHub/Contaminant Mapping/Contaminant-Mapping")

required.packages <- c("sp", "XML", "rgdal", "rgeos", "raster", "ggplot2", 
                       "dismo", "leaflet", "RColorBrewer", "classInt", "dplyr")
suppressMessages(lapply(required.packages, require, character.only = TRUE))

dat = read.csv(file = "TDS_Features_Tulare_Clip_TableToExcel.csv", stringsAsFactors = FALSE) # 54,171 total observations
```

# Data Wrangling
```{r Data Wrangling, warning = FALSE, messages = FALSE, results = "hide"}
# add dates to dat
dat <- dat %>% 
  mutate(Date = as.Date(Samp_Date))

# filter observations with depth info, add time_period
dat_with_depth <- dat %>% 
  filter(Depth_ft != "NA" | 0) %>% 
  mutate(time_period = 
           ifelse(Year %in% 1923:1959, "1923-1959",
           ifelse(Year %in% 1960:1969, "1960-1969",
           ifelse(Year %in% 1970:1979, "1970-1979",
           ifelse(Year %in% 1980:1989, "1980-1989",                  
           ifelse(Year %in% 1990:1999, "1990-1999",
           ifelse(Year %in% 2000:2014, "2000-2014", NA))))))
         )

unique(dat_with_depth$Database) # all wells with depth information come from the USGS databse
unique(dat_with_depth$time_period) # all time periods are represented

# visualize
dat_with_depth %>% 
  ggplot() +
  geom_histogram(aes(x = Depth_ft)) + 
  xlab('depth (ft)') + 
  ggtitle('USGS Wells by depth') +
  theme_light()
# most wells are shallow (< 250 feet)

# create depth classes
dat_with_depth$Depth_ft <- round(dat_with_depth$Depth_ft) # round Depth_ft to avoid creating NAs in depth_class

dat_with_depth <- dat_with_depth %>% 
  mutate(depth_class = 
           ifelse(Depth_ft %in% 0:249, "0-249 ft",
           ifelse(Depth_ft %in% 250:749, "250-749 ft",
           ifelse(Depth_ft %in% 750: 3000, "750-3000 ft", NA))))

# visualize
dat_with_depth %>% 
  ggplot() +
  geom_bar(aes(x = depth_class, fill = time_period)) + 
  ggtitle('USGS wells by depth and time period') +
  scale_x_discrete(limits = c('0-249 ft', '250-749 ft' , '750-3000 ft')) +
  theme_light()
```

# Visualize USGS data - Develop Map Function for Time Period
```{r visualize USGS data}
# Is there sampling bias in the wells that have depth information to them? Let's look at the spatial distribution of these USGS wells which we have depth information for.

# define coordinates
well_coords = cbind(dat_with_depth$Longitude, dat_with_depth$Latitude)
pts = SpatialPoints(well_coords)

# deinfe color palette to be used. blue values correspond to fresh water, red to salty water
co = c("blue","steelblue2","steelblue1","seashell1","orangered1","red3")

# define map center for all maps and plug into setView
center_coords <- dat_with_depth %>% 
  filter(depth_class == "750-3000 ft" & time_period == "2000-2014") %>% 
  summarise(latCenter = mean(Latitude) + .23,
            lonCenter = mean(Longitude))

# define map function
map.TDS.period = function(t, d){
  # create time and depth class (t.d) subset for the t and d arguments  
  t.d <-  dat_with_depth %>% 
    filter(time_period == t & depth_class == d) 
  
  # create logical vector for all t and d indexes to extract coordinates of these observations
  t.d.pts = ifelse(dat_with_depth$depth_class == d & 
                   dat_with_depth$time_period == t, TRUE, FALSE)
  
  # use logical vector to subset well_coords, and create spatial points data frame for time frame t and depth d
  ptsdf = SpatialPointsDataFrame(pts[t.d.pts , ], data = t.d)
  
  # define palette based on time frame t and depth class d observations
  # set bins with a vector of breaks, so they are fine from 0 - 1,000 and coarse from 1,000 - 50,000
  pal = colorBin(palette = co,
           domain = t.d$Result, bins = c(0,200,400,600,800,1000,
                                          5000,10000,50000))
  
  # generate map assocaited with time frame t and depth d
  map <- leaflet(data = ptsdf) 
  map <- addTiles(map)
  map %>%
    addCircleMarkers(
      lng = well_coords[t.d.pts,1], # longitude
      lat = well_coords[t.d.pts,2], # latitude
      radius = 4, # fixed radius size
      color = ~pal(Result),
      stroke = FALSE, 
      fillOpacity = 0.8,
      popup = paste(ptsdf$Result, " mg/L TDS", "<br>",
                    "Database: ", ptsdf$Database, "<br>",
                    "Well ID: ", ptsdf$Well_ID, "<br>",
                    "Latitude: ", ptsdf$Latitude, "<br>",
                    "Longitude: ", ptsdf$Longitude)
    ) %>%
    
    addLegend("topright", pal = pal, # use custom palette
              values = ~Result,
              title = paste(t, d, sep = ", "), # legend displays time frame and depth class as title
              labFormat = labelFormat(suffix = " mg/L"),
              opacity = 1
    ) %>%
    
    addProviderTiles(providers$Esri.WorldTerrain # override default map with ESRI world terrain map
  
    ) %>% 
    
    setView(lng = center_coords$lonCenter, lat = center_coords$latCenter, zoom = 8) # iteratively changed zoom until it centered on the data
}

# run map function for all decades and depth classes
t <- c("1923-1959", "1960-1969", "1970-1979", "1980-1989", "1990-1999", "2000-2014")
d <- c('0-249 ft', '250-749 ft', '750-3000 ft')

for(i in t){
  for(j in d){
    print(list(map.TDS.period(i,j)))
  }
}

# spatial coverage of data depends on depth_class and time_frame. Deep and intermediate wells show high density around the urban centers of Fresno and Bakersfield. Shallow well data from 1980-1989, especially in the Eastern SJ Valley is very dense, likely the result of the emergence of non-point source contamination in the region and an effort to assess the magnitude and distribution of these patterns in groundwater quality. This widespread monitoring effort does not continue as time goes on.
```

# Determine if wells in other databases match USGS wells
```{r}
dat_USGS <- dat_with_depth
dat_other <- dat %>% 
  filter(Database != "USGS")

merge(dat_USGS, dat_other, by = c("Latitude", "Longitude"))

# no well lat/lng coordiantes within the USGS database match well coordinates within the other databases. This indicates that USGS has never taken over wells from another database, or passed on responsibility for monitoring its own wells. This means we cannot infer the depth of wells from other databases based on the Depth_ft information we have in the USGS database.
```

# Is there a relationship between depth and TDS?
```{r}
# for the earliest decade:
boundary_condition <- dat_with_depth %>% 
  filter(Year <= 1960, Result <= 2000) %>% # start near the beginning of 1960 to set broundary conditions of model, filter out excessively contaminated wells to see the actaul pattern in groundwater TDS
  ggplot() +
  geom_point(aes(x = -Depth_ft, y = Result, color = depth_class)) +
  geom_smooth(aes(x = -Depth_ft, y = Result), color = "black") +
  ylab('TDS (mg/L)') +
  xlab('Depth (ft)') + 
  labs(color = 'Depth Class') + 
  coord_flip() +
  theme_light()

boundary_dat <- ggplot_build(boundary_condition)$data[[2]]

ggplot(boundary_dat) +
  geom_point(aes(x = y, y = x))

# we will use this data to set the boundary conditions for the mixing cell model
```

# How much has average GW quality in wells changed over time?
```{r}
dat_with_depth %>% 
  group_by(time_period, depth_class) %>% 
  dplyr::summarize(Result_mean = mean(Result),
    count = n()) %>% 
  ggplot() + 
  geom_line(aes(x = factor(time_period), y = Result_mean, group = depth_class, color = depth_class)) + 
  xlab('Time Period') +
  ylab('TDS (mg/L)') + 
  ggtitle('Mean Groundwater Quality in the Tulare Basin') + 
  labs(color = 'Depth Class') +
  theme_light()

# An examination of the maps hallow groundwater quality does not actually improve between 1980. Sampling bias contributes towards a lack of data from 2000-2014. Let's now examine GW quality trends in individual wells.
```

# Prepare Basemaps Maps for Next Sections
```{r}
library(maps)
library(mapdata)

# create Tulare basin from the Fresno, Kern, Kings, and Tulare counties
counties <- map_data("county")
ca_county <- subset(counties, region == "california")
tulare <- ca_county %>% 
  filter(subregion %in% c('fresno', 'kern', 'kings', 'tulare'))

# create dataframe with coordinates for Fresno and Bakersfield, to act as markers
cities <- data.frame(city = c('Fresno', 'Bakersfield'),
                     longitude = c(-119.7726, -119.0187), 
                     latitude = c(36.7468, 35.3733)
                     )

# get California points from maps
states <- map_data("state")
ca_df <- subset(states, region == "california")

# first plot the base
ca_base <- ggplot(data = ca_df, mapping = aes(x = long, y = lat, group = group)) + 
  coord_fixed(1.3) + 
  geom_polygon(color = "black", fill = "gray") +
  geom_polygon(data = tulare, fill = NA, color = 'blue') +
  theme_void()

tulare_base <- ggplot(data = tulare, mapping = aes(x = long, y = lat, group = group)) + 
  coord_fixed(1.3) + 
  geom_polygon(color = "blue", fill = "gray") +
  theme_void()

# plot California and Tulare together
multiplot(ca_base, tulare_base, cols = 2)
```

# Examine Whole of Shallow and Deep Well Data before Analyzing Continuous and Discontinuous
```{r}
# all shallow well observations
all_shallow <- dat %>% 
  filter(DepthClass == "Shallow") %>% 
  mutate(has_depth_data = ifelse(!is.na(Depth_ft), TRUE, FALSE)) 

# unique shallow well observations
unique_shallow <- all_shallow[!duplicated(all_shallow$Well_ID), ] # subsets for all unique Well_ID

# map of unique shallow wells
map_unique_shallow <- tulare_base +
  geom_point(data = unique_shallow, aes(x = Longitude, y = Latitude, group = Well_ID, color = has_depth_data), size = .5) +
  geom_point(data = cities, mapping = aes(x = longitude, y = latitude, group = factor(city))) +
  geom_text(data = cities, mapping = aes(x = longitude, y = latitude, group = factor(city), label = city), hjust = 0, vjust = -.5) + 
  theme(legend.position= c(0.25, 0.9)) +
  labs(caption = "(a)") + 
  annotate("text", 
           x = min(unique_shallow$Longitude), y = min(unique_shallow$Latitude), 
           label = paste("n = ", length(unique_shallow$Well_ID))
           ) +
  theme(plot.margin = unit(c(.5,.5,.5,.5), "cm"))

# stacked bar plot of unique shallow wells with fill = has_depth_data
p_unique_shallow <- unique_shallow %>% 
  ggplot(aes(x = Year)) + 
  geom_bar(color = "black", aes(fill = has_depth_data)) +
  xlab('Year') +
  ylab('Observations') +
  labs(caption = "(a)") +
  xlim(1940, 2020) +
  theme_light(base_size = 12) +
  theme(legend.position = c(.25,.85)) +
  theme(plot.margin = unit(c(.5,.5,.5,.5), "cm"))

# unique shallow with depth observations
unique_shallow_with_depth <- unique_shallow %>% 
  filter(!is.na(Depth_ft))

# calculate mean and sd from lognormal distribution using Cox method (Land, 1971)
library(EnvStats)
lognorm_shallow <- elnormAlt(unique_shallow_with_depth$Depth_ft, method = "mvue", ci = FALSE, ci.type = "two-sided", 
    ci.method = "land", conf.level = 0.95)

shallow_mean <- round(lognorm_shallow$parameters[1], 2)
shallow_sd <- round(lognorm_shallow$parameters[1] * lognorm_shallow$parameters[2], 2)

# plot histogram of unique shallow wells with depth information
p_unique_shallow_with_depth <- ggplot(unique_shallow_with_depth, aes(x = Depth_ft)) +
  geom_histogram(bins = 50, color = "black", fill = '#00BFC4') + 
  annotate("text", 
           y = 200, x = 400, 
           label = paste("n = ", length(unique_shallow_with_depth$Well_ID), "\n",
                         "μ = ", shallow_mean, "\n",
                         "σ = ", shallow_sd)) +
  xlab('Well Depth (ft)') +
  labs(caption = "(a)") +
  theme_light(base_size = 12) +
  theme(plot.margin = unit(c(.5,.5,.5,.5), "cm"))


# Now let's repeat these analyses for deep wells:

# all deep well observations
all_deep <- dat %>% 
  filter(DepthClass == "Deep") %>% 
  mutate(has_depth_data = ifelse(!is.na(Depth_ft), TRUE, FALSE)) 

# unique shallow well observations
unique_deep <- all_deep[!duplicated(all_deep$Well_ID), ] # subsets for all unique Well_ID

# map of unique shallow wells
map_unique_deep <- tulare_base +
  geom_point(data = unique_deep, aes(x = Longitude, y = Latitude, group = Well_ID, color = has_depth_data), size = .5) +
  geom_point(data = cities, mapping = aes(x = longitude, y = latitude, group = factor(city))) +
  geom_text(data = cities, mapping = aes(x = longitude, y = latitude, group = factor(city), label = city), hjust = 0, vjust = -.5) + 
  theme(legend.position= c(0.25, 0.9)) +
  labs(caption = "(b)") + 
  annotate("text", 
           x = min(unique_deep$Longitude), y = min(unique_deep$Latitude), 
           label = paste("n = ", length(unique_deep$Well_ID))
           ) +
  theme(plot.margin = unit(c(.5,.5,.5,.5), "cm"))

# stacked bar plot of unique shallow wells with fill = has_depth_data
p_unique_deep <- unique_deep %>% 
  ggplot(aes(x = Year)) + 
  geom_bar(color = "black", aes(fill = has_depth_data)) +
  xlab('Year') +
  ylab('Observations') +
  labs(caption = "(b)") +
  xlim(1940, 2020) +
  theme_light(base_size = 12) +
  theme(legend.position = c(.25,.85)) +
  theme(plot.margin = unit(c(.5,.5,.5,.5), "cm"))

# unique shallow with depth observations
unique_deep_with_depth <- unique_deep%>% 
  filter(!is.na(Depth_ft))

# calculate mean and sd from lognormal distribution using Cox method (Land, 1971)
library(EnvStats)
lognorm_deep <- elnormAlt(unique_deep_with_depth$Depth_ft, method = "mvue", ci = FALSE, ci.type = "two-sided", 
    ci.method = "land", conf.level = 0.95)

deep_mean <- round(lognorm_deep$parameters[1], 2)
deep_sd <- round(lognorm_deep$parameters[1] * lognorm_deep$parameters[2], 2)

# plot histogram 
p_unique_deep_with_depth <- ggplot(unique_deep_with_depth, aes(x = Depth_ft)) +
  geom_histogram(bins = 50, color = "black", fill = '#00BFC4') + 
  xlab('Well Depth (ft)') +
  labs(caption = "(b)") +
  theme_light(base_size = 12) + 
  annotate("text", 
           y = 47, x = 1100, 
           label = paste("n = ", length(unique_deep_with_depth$Well_ID), "\n",
                         "μ = ", deep_mean, "\n",
                         "σ = ", deep_sd)) +
  xlab('Well Depth (ft)') +
  labs(caption = "(b)") +
  theme_light(base_size = 12) +
  theme(plot.margin = unit(c(.5,.5,.5,.5), "cm"))


# multiplot of shallow and deep wells
multiplot(map_unique_shallow, map_unique_deep, p_unique_shallow, p_unique_deep, p_unique_shallow_with_depth, p_unique_deep_with_depth, cols = 3)

```

# How has GW quality in individual wells changed over time? (Deep)
```{r}
# strat working with complete data (dat) rather than data with explicit depth (dat_with_depth)

# Deep wells with Continuous (n >= 25) data
deep_continuous_early <- dat[ave(dat$Year, dat$Well_ID, FUN = length) >= 25, ] %>% 
  filter(DepthClass == "Deep") %>% 
  filter(Result < 2000 & Result > 5, Year < 1980) %>% 
  group_by(Date, Well_ID, Latitude, Longitude) %>% 
  dplyr::summarise(Result_mean = mean(Result))

deep_continuous_late <- dat[ave(dat$Year, dat$Well_ID, FUN = length) >= 25, ] %>% 
  filter(DepthClass == "Deep") %>% 
  filter(Result < 2000 & Result > 5, Year >= 1980) %>% 
  group_by(Date, Well_ID, Latitude, Longitude) %>% 
  dplyr::summarise(Result_mean = mean(Result))

p_deep_continuous <-
  ggplot() + 
  geom_line(data = deep_continuous_late, aes(x = Date, y = Result_mean, group = Well_ID), alpha = 1/5) + 
  geom_point(data = deep_continuous_late, aes(x = Date, y = Result_mean, group = Well_ID), alpha = 1/3) + 
  geom_smooth(data = deep_continuous_late, color = 'red', se = FALSE, aes(x = Date, y = Result_mean)) +
  geom_line(data = deep_continuous_early, aes(x = Date, y = Result_mean, group = Well_ID), alpha = 1/5) + 
  geom_point(data = deep_continuous_early, aes(x = Date, y = Result_mean, group = Well_ID), alpha = 1/3) + 
  xlab('Time') +
  ylab('TDS (mg/L)') + 
  ylim(0, 2000) + 
  xlim(as.Date("1940", "%Y"), as.Date("2020", "%Y")) +
  annotate("text", 
           y = 1750, x = as.Date("1950", "%Y"), 
           label = paste("n = ", as.character(
             length(unique(deep_continuous_early$Well_ID)) +
             length(unique(deep_continuous_late$Well_ID))), sep = "")) +
  labs(caption = "(a)") +
  theme_light(base_size = 12) 

# Deep wells with Discontinous (n >= 0) data
deep_discontinuous_late <- dat %>% 
  filter(DepthClass == "Deep") %>% 
  filter(Result < 2000 & Result > 5 & Year >= 1970) %>% 
  group_by(Date, Well_ID, Latitude, Longitude) %>% 
  dplyr::summarise(Result_mean = mean(Result))

deep_discontinuous_early <- dat %>% 
  filter(DepthClass == "Deep") %>% 
  filter(Result < 2000 & Result > 5 & Year < 1970 & Year > 1930) %>% 
  group_by(Date, Well_ID, Latitude, Longitude) %>% 
  dplyr::summarise(Result_mean = mean(Result))

p_deep_discontinuous <-
  ggplot() + 
  geom_line(data = deep_discontinuous_late, aes(x = Date, y = Result_mean, group = Well_ID), alpha = 1/5) + 
  geom_point(data = deep_discontinuous_late, aes(x = Date, y = Result_mean, group = Well_ID), alpha = 1/3) + 
  geom_smooth(data = deep_discontinuous_late, color = 'red', se = FALSE, aes(x = Date, y = Result_mean)) +
  geom_line(data = deep_discontinuous_early, aes(x = Date, y = Result_mean, group = Well_ID), alpha = 1/5) + 
  geom_point(data = deep_discontinuous_early, aes(x = Date, y = Result_mean, group = Well_ID), alpha = 1/3) + 
  xlab('Time') +
  ylab('TDS (mg/L)') + 
  ylim(0, 2000) + 
  xlim(as.Date("1940", "%Y"), as.Date("2020", "%Y")) +
  annotate("text", 
           y = 1750, x = as.Date("1950", "%Y"), 
           label = paste("n = ", as.character(
             length(unique(deep_discontinuous_late$Well_ID)) +
             length(unique(deep_discontinuous_early$Well_ID))), sep = "")) +
  labs(caption = "(b)") +
  theme_light(base_size = 12) 

# map for continuous deep wells
map_deep_continuous <- tulare_base +
  geom_point(data = deep_continuous_early, aes(x = Longitude, y = Latitude, group = Well_ID), size = .5, color = 'red', alpha = 1/5) +
  geom_point(data = deep_continuous_late, aes(x = Longitude, y = Latitude, group = Well_ID), size = .5, color = 'red', alpha = 1/5) +
  geom_point(data = cities, mapping = aes(x = longitude, y = latitude, group = factor(city))) +
  geom_text(data = cities, mapping = aes(x = longitude, y = latitude, group = factor(city), label = city), hjust = 0, vjust = -.5) +
  labs(caption = "(a)")

# map for discontinuous deep wells
map_deep_discontinuous <- tulare_base +
  geom_point(data = deep_discontinuous_early, aes(x = Longitude, y = Latitude, group = Well_ID), size = .5, color = 'red', alpha = 1/5) +
  geom_point(data = deep_discontinuous_late, aes(x = Longitude, y = Latitude, group = Well_ID), size = .5, color = 'red', alpha = 1/5) +
  geom_point(data = cities, mapping = aes(x = longitude, y = latitude, group = factor(city))) +
  geom_text(data = cities, mapping = aes(x = longitude, y = latitude, group = factor(city), label = city), hjust = 0, vjust = -.5) +
  labs(caption = "(b)")
  
multiplot(map_deep_continuous, map_deep_discontinuous, p_deep_continuous, p_deep_discontinuous, cols = 2)
```

# How has GW quality in individual wells changed over time? (Shallow)
```{r}
# Shallow wells with Continuous (n >= 25) data
shallow_continuous_early <- dat[ave(dat$Year, dat$Well_ID, FUN = length) >= 25, ] %>% 
  filter(DepthClass == "Shallow" & Year < 2005 & Result < 20000) %>% 
  group_by(Date, Well_ID, Latitude, Longitude) %>% 
  dplyr::summarise(Result_mean = mean(Result))

shallow_continuous_late <- dat[ave(dat$Year, dat$Well_ID, FUN = length) >= 25, ] %>% 
  filter(DepthClass == "Shallow" & Year >= 2005 & Result < 20000) %>% 
  group_by(Date, Well_ID, Latitude, Longitude) %>% 
  dplyr::summarise(Result_mean = mean(Result))
  
p_shallow_continuous <- 
  ggplot() + 
  geom_line(data = shallow_continuous_early, aes(x = Date, y = Result_mean, group = Well_ID), alpha = 1/5) + 
  geom_point(data = shallow_continuous_early, aes(x = Date, y = Result_mean, group = Well_ID), alpha = 1/3) + 
  geom_line(data = shallow_continuous_late, aes(x = Date, y = Result_mean, group = Well_ID), alpha = 1/5) + 
  geom_point(data = shallow_continuous_late, aes(x = Date, y = Result_mean, group = Well_ID), alpha = 1/3) + 
  geom_smooth(data = shallow_continuous_late, color = 'red', se = FALSE, aes(x = Date, y = Result_mean)) +
  xlab('Time') +
  ylab('TDS (mg/L)') + 
  ylim(0, 20000) + 
  xlim(as.Date("1940", "%Y"), as.Date("2020", "%Y")) +
  annotate("text", 
           y = 17500, x = as.Date("1950", "%Y"), 
           label = paste("n = ", as.character(
             length(unique(shallow_continuous_early$Well_ID)) + 
             length(unique(shallow_continuous_late$Well_ID))), sep = "")) +
  labs(caption = "(a)") +
  theme_light(base_size = 12) 

# Shallow wells with Discontinous (n >= 0) data
shallow_discontinuous_late <- dat %>% 
  filter(DepthClass == "Shallow" & Year >= 1993 & Result < 20000) %>% 
  group_by(Date, Well_ID, Latitude, Longitude) %>% 
  dplyr::summarise(Result_mean = mean(Result)) 

shallow_discontinuous_middle <- dat %>% 
  filter(DepthClass == "Shallow" & Year < 1993 & Year >= 1984 & Result < 20000) %>% 
  group_by(Date, Well_ID, Latitude, Longitude) %>% 
  dplyr::summarise(Result_mean = mean(Result))

shallow_discontinuous_early <- dat %>% 
  filter(DepthClass == "Shallow" & Year < 1984 & Result < 20000) %>% 
  group_by(Date, Well_ID, Latitude, Longitude) %>% 
  dplyr::summarise(Result_mean = mean(Result))

p_shallow_discontinuous <- 
  ggplot() + 
  geom_line(data = shallow_discontinuous_late, aes(x = Date, y = Result_mean, group = Well_ID), alpha = 1/5) + 
  geom_point(data = shallow_discontinuous_late, aes(x = Date, y = Result_mean, group = Well_ID), alpha = 1/3) + 
  geom_smooth(data = shallow_discontinuous_late, color = 'red', se = FALSE, aes(x = Date, y = Result_mean)) +
  geom_line(data = shallow_discontinuous_middle, aes(x = Date, y = Result_mean, group = Well_ID), alpha = 1/5) + 
  geom_point(data = shallow_discontinuous_middle, aes(x = Date, y = Result_mean, group = Well_ID), alpha = 1/3) + 
  geom_smooth(data = shallow_discontinuous_middle, color = 'red', se = FALSE, aes(x = Date, y = Result_mean)) +
  geom_line(data = shallow_discontinuous_early, aes(x = Date, y = Result_mean, group = Well_ID), alpha = 1/5) + 
  geom_point(data = shallow_discontinuous_early, aes(x = Date, y = Result_mean, group = Well_ID), alpha = 1/3) + 
  xlab('Time') +
  ylab('TDS (mg/L)') + 
  ylim(0, 20000) + 
  xlim(as.Date("1940", "%Y"), as.Date("2020", "%Y")) +
  annotate("text", 
           y = 17500, x = as.Date("1950", "%Y"), 
           label = paste("n = ", as.character(
             length(unique(shallow_discontinuous_early$Well_ID)) +
             length(unique(shallow_discontinuous_middle$Well_ID)) +
             length(unique(shallow_discontinuous_late$Well_ID))), sep = "")) +
  labs(caption = "(b)") +
  theme_light(base_size = 12)

# map for continuous shallow wells
map_shallow_continuous <- tulare_base +
  geom_point(data = shallow_continuous_early, aes(x = Longitude, y = Latitude, group = Well_ID), size = .5, color = 'red', alpha = 1/5) +
  geom_point(data = shallow_continuous_late, aes(x = Longitude, y = Latitude, group = Well_ID), size = .5, color = 'red', alpha = 1/5) +
  geom_point(data = cities, mapping = aes(x = longitude, y = latitude, group = factor(city))) +
  geom_text(data = cities, mapping = aes(x = longitude, y = latitude, group = factor(city), label = city), hjust = 0, vjust = -.5) +
  labs(caption = "(a)")

# map for discontinuous shallow wells
map_shallow_discontinuous <- tulare_base +
  geom_point(data = shallow_discontinuous_early, aes(x = Longitude, y = Latitude, group = Well_ID), size = .5, color = 'red', alpha = 1/5) +
  geom_point(data = shallow_discontinuous_middle, aes(x = Longitude, y = Latitude, group = Well_ID), size = .5, color = 'red', alpha = 1/5) +
  geom_point(data = shallow_discontinuous_late, aes(x = Longitude, y = Latitude, group = Well_ID), size = .5, color = 'red', alpha = 1/5) +
  geom_point(data = cities, mapping = aes(x = longitude, y = latitude, group = factor(city))) +
  geom_text(data = cities, mapping = aes(x = longitude, y = latitude, group = factor(city), label = city), hjust = 0, vjust = -.5) +
  labs(caption = "(b)")

multiplot(map_shallow_continuous, map_shallow_discontinuous, p_shallow_continuous, p_shallow_discontinuous, cols = 2)

```


# Appendix: 
## Depth Class
##### Exerpt from “Initial Conceptual Model (ICM) Technical Services Tasks 7 and 8 – Salt and Nitrate Analysis for the Central Valley Floor and a Focused Analysis of Modesto and Kings Subregions Final Report.” [@LarryWalkerAssociates2013]:
>Wells were classified into three depth classes (Shallow, Deep, and Unknown) based on information provided by the original source, as shown in Table 3-2. Most wells in the database did not contain quantitative information on well depth or screened interval; however, other information such as well type was used when available to infer the depth from which a well was sampled. Only the USGS database contained quantitative information regarding well depth. For wells lacking a specified value of well depth, the well type was used to infer the depth (see Table 3-2 for examples). Wells in the DWR, GeotrackerGAMA, and RWQCB WDR Dairy Data databases sometimes contain a description of the well type which enabled categorization of the well into a depth class. All wells from the DPH database were assumed to be drinking water supply wells.
Irrigation/agricultural, industrial, and municipal supply wells were classified as “Deep” whereas domestic wells and monitoring wells were classified as “Shallow”. All DPH wells were therefore classified as “Deep” as these were all assumed to be drinking water supply wells. All other well types were classified as “Unknown”.
A large number of USGS wells provided numerical values for well depth; therefore, these were used when provided. USGS wells were assigned a depth class based on the 20-year travel depth for a particular CVHM cell that it was located within. Wells with a depth less than the 20-year travel depth were classified as “Shallow,” and those below the 20-year travel depth were classified as “Deep”. Wells without depth information or a well type were classified as “Unknown”. 

# References


[^1]: [United States Geologic Survey](https://www.usgs.gov/)
[^2]: [California Department of Public Health](https://www.cdph.ca.gov/)
[^3]: [Groundwater Ambient Monitoring and Assessment Program](http://www.swrcb.ca.gov/gama/)
[^4]: [Environmental Defense Fund](https://www.edf.org/) 
[^5]: [California Department of Water Resources](http://www.water.ca.gov/)